<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kalkulator Kredit — Tailwind (Aman Copas)</title>
  <!-- Tailwind CDN (untuk pengembangan cepat) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* sedikit styling tambahan */
    .thin-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
    .thin-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 999px; }
    .thin-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-4 sm:p-6">
    <header class="mb-6">
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Kalkulator Kredit</h1>
      <p class="text-slate-600">Hitung cicilan bulanan, total bunga, dan lihat tabel amortisasi (Anuitas/Efektif & Flat).</p>
    </header>

    <div class="grid md:grid-cols-3 gap-4 items-start">
      <section class="md:col-span-2 bg-white rounded-2xl shadow p-4 sm:p-6">
        <h2 class="font-semibold text-lg mb-4">Data Pinjaman</h2>
        <form id="loanForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm text-slate-600">Harga/Plafon (Rp)</span>
            <input type="text" inputmode="numeric" id="amount" required placeholder="100000000" class="mt-1 w-full rounded-xl border-slate-300 focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2" />
          </label>

          <label class="block">
            <span class="text-sm text-slate-600">Uang Muka (Rp) — opsional</span>
            <input type="text" inputmode="numeric" id="downPayment" placeholder="0" class="mt-1 w-full rounded-xl border-slate-300 focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2" />
          </label>

          <label class="block">
            <span class="text-sm text-slate-600">Suku Bunga (% per tahun)</span>
            <input type="number" step="0.01" min="0" id="annualRate" required placeholder="12" class="mt-1 w-full rounded-xl border-slate-300 focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2" />
          </label>

          <div class="grid grid-cols-3 gap-2 sm:gap-3">
            <label class="block col-span-2">
              <span class="text-sm text-slate-600">Tenor</span>
              <input type="number" min="1" id="tenor" required placeholder="36" class="mt-1 w-full rounded-xl border-slate-300 focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2" />
            </label>
            <label class="block">
              <span class="text-sm text-slate-600">Satuan</span>
              <select id="tenorUnit" class="mt-1 w-full rounded-xl border-slate-300 focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                <option value="bulan">Bulan</option>
                <option value="tahun">Tahun</option>
              </select>
            </label>
          </div>

          <label class="block">
            <span class="text-sm text-slate-600">Jenis Bunga</span>
            <select id="interestType" class="mt-1 w-full rounded-xl border-slate-300 focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
              <option value="anuitas">Anuitas / Efektif</option>
              <option value="flat">Flat</option>
            </select>
          </label>

          <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4">
            <label class="block">
              <span class="text-sm text-slate-600">Biaya Admin (Rp)</span>
              <input type="text" inputmode="numeric" id="adminFee" placeholder="0" class="mt-1 w-full rounded-xl border-slate-300 focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2" />
            </label>
            <label class="block">
              <span class="text-sm text-slate-600">Asuransi (Rp)</span>
              <input type="text" inputmode="numeric" id="insurance" placeholder="0" class="mt-1 w-full rounded-xl border-slate-300 focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2" />
            </label>
            <label class="flex items-center gap-2 mt-6">
              <input type="checkbox" id="rollFees" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
              <span class="text-sm">Gabungkan biaya ke pinjaman</span>
            </label>
          </div>

          <div class="sm:col-span-2 flex flex-wrap gap-2 mt-2">
            <button type="submit" class="px-4 py-2 rounded-2xl bg-indigo-600 text-white font-medium hover:bg-indigo-700 focus:outline-none">Hitung</button>
            <button type="button" id="resetBtn" class="px-4 py-2 rounded-2xl bg-slate-200 text-slate-800 hover:bg-slate-300">Reset</button>
            <button type="button" id="downloadBtn" class="px-4 py-2 rounded-2xl bg-emerald-600 text-white hover:bg-emerald-700" disabled>Unduh CSV</button>
            <button type="button" id="printBtn" class="px-4 py-2 rounded-2xl bg-slate-800 text-white hover:bg-black" disabled>Cetak</button>
          </div>
        </form>
      </section>

      <aside class="bg-white rounded-2xl shadow p-4 sm:p-6 sticky top-4">
        <h2 class="font-semibold text-lg mb-4">Ringkasan</h2>
        <dl class="space-y-3 text-sm">
          <div class="flex justify-between">
            <dt>Pinjaman Bersih</dt>
            <dd id="summaryPrincipal" class="font-semibold">Rp0</dd>
          </div>
          <div class="flex justify-between">
            <dt>Cicilan / Bulan</dt>
            <dd id="summaryPayment" class="font-semibold">Rp0</dd>
          </div>
          <div class="flex justify-between">
            <dt>Total Bunga</dt>
            <dd id="summaryInterest" class="font-semibold">Rp0</dd>
          </div>
          <div class="flex justify-between">
            <dt>Total Pembayaran</dt>
            <dd id="summaryTotal" class="font-semibold">Rp0</dd>
          </div>
        </dl>
        <p id="note" class="text-xs text-slate-500 mt-4">Catatan: Perhitungan anuitas menggunakan suku bunga efektif bulanan dengan pembulatan 2 desimal.</p>
      </aside>
    </div>

    <section id="tableSection" class="mt-6 hidden">
      <div class="bg-white rounded-2xl shadow overflow-hidden">
        <div class="flex items-center justify-between p-4">
          <h3 class="font-semibold">Tabel Amortisasi</h3>
          <div class="flex items-center gap-2">
            <label class="text-sm text-slate-600">Baris per halaman</label>
            <select id="rowsPerPage" class="rounded-xl border-slate-300 focus:border-indigo-500 focus:ring-indigo-500 text-sm px-2 py-1">
              <option>12</option>
              <option>24</option>
              <option>60</option>
              <option>120</option>
              <option>Semua</option>
            </select>
          </div>
        </div>
        <div class="overflow-x-auto thin-scroll">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 text-slate-600">
              <tr>
                <th class="text-left px-4 py-2">#</th>
                <th class="text-right px-4 py-2">Pembayaran</th>
                <th class="text-right px-4 py-2">Bunga</th>
                <th class="text-right px-4 py-2">Pokok</th>
                <th class="text-right px-4 py-2">Sisa Pokok</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        <div class="flex items-center justify-between p-4 border-t">
          <button id="prevPage" class="px-3 py-1.5 rounded-xl bg-slate-200 hover:bg-slate-300 disabled:opacity-40">Sebelumnya</button>
          <span id="pageInfo" class="text-sm text-slate-600"></span>
          <button id="nextPage" class="px-3 py-1.5 rounded-xl bg-slate-200 hover:bg-slate-300 disabled:opacity-40">Berikutnya</button>
        </div>
      </div>
    </section>

    <footer class="text-center text-xs text-slate-500 mt-6">
      Dibuat untuk perhitungan cepat — selalu verifikasi dengan simulasi resmi lembaga pembiayaan.
    </footer>
  </div>

  <script>
    // Util: format & parse rupiah (lebih toleran)
    var rupiah = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 });

    function parseNumber(s) {
      if (typeof s === 'number') return s;
      if (!s) return 0;
      // ambil hanya digit (aman untuk berbagai input)
      var cleaned = ('' + s).replace(/[^0-9-]/g, '');
      var n = parseFloat(cleaned);
      return isNaN(n) ? 0 : n;
    }

    function fmt(n) { return rupiah.format(Math.round(n)); }

    // Elemen
    var amountEl = document.getElementById('amount');
    var downEl = document.getElementById('downPayment');
    var rateEl = document.getElementById('annualRate');
    var tenorEl = document.getElementById('tenor');
    var unitEl = document.getElementById('tenorUnit');
    var typeEl = document.getElementById('interestType');
    var adminEl = document.getElementById('adminFee');
    var insEl = document.getElementById('insurance');
    var rollEl = document.getElementById('rollFees');

    var sumPrincipal = document.getElementById('summaryPrincipal');
    var sumPayment = document.getElementById('summaryPayment');
    var sumInterest = document.getElementById('summaryInterest');
    var sumTotal = document.getElementById('summaryTotal');

    var tableSection = document.getElementById('tableSection');
    var tableBody = document.getElementById('tableBody');
    var rowsPerPageEl = document.getElementById('rowsPerPage');
    var prevBtn = document.getElementById('prevPage');
    var nextBtn = document.getElementById('nextPage');
    var pageInfo = document.getElementById('pageInfo');

    var dlBtn = document.getElementById('downloadBtn');
    var printBtn = document.getElementById('printBtn');

    var schedule = [];
    var currentPage = 1;

    // Format input rupiah saat blur (opsional, membuat nyaman)
    var elemsToFormat = [amountEl, downEl, adminEl, insEl];
    elemsToFormat.forEach(function(el) {
      el.addEventListener('blur', function() {
        var n = parseNumber(el.value);
        el.value = n ? fmt(n) : '';
      });
    });

    document.getElementById('loanForm').addEventListener('submit', function(e) {
      e.preventDefault();
      calculate();
    });

    document.getElementById('resetBtn').addEventListener('click', function() {
      document.getElementById('loanForm').reset();
      sumPrincipal.textContent = sumPayment.textContent = sumInterest.textContent = sumTotal.textContent = 'Rp0';
      tableSection.classList.add('hidden');
      dlBtn.disabled = true; printBtn.disabled = true;
    });

    rowsPerPageEl.addEventListener('change', function() { renderTable(); });
    prevBtn.addEventListener('click', function() { if (currentPage > 1) { currentPage--; renderTable(); } });
    nextBtn.addEventListener('click', function() { currentPage++; renderTable(); });
    dlBtn.addEventListener('click', function() { downloadCSV(); });
    printBtn.addEventListener('click', function() { window.print(); });

    function calculate() {
      var price = parseNumber(amountEl.value);
      var dp = parseNumber(downEl.value);
      var admin = parseNumber(adminEl.value);
      var ins = parseNumber(insEl.value);
      var rateY = parseFloat(rateEl.value || '0');
      var n = parseInt(tenorEl.value || '0', 10);
      if (unitEl.value === 'tahun') n = n * 12;

      if (!price || !n) {
        alert('Mohon isi Harga/Plafon dan Tenor yang valid.');
        return;
      }

      var principalBase = Math.max(0, price - dp);
      var financedFees = rollEl.checked ? (admin + ins) : 0;
      var P = principalBase + financedFees;

      var r = (rateY / 100) / 12; // bunga bulanan

      var pay = 0;
      var scheduleOut = [];
      var totalInterest = 0;

      if (typeEl.value === 'anuitas') {
        if (r === 0) {
          pay = P / n;
        } else {
          var denom = 1 - Math.pow(1 + r, -n);
          if (denom === 0) {
            alert('Kesalahan perhitungan: tenor atau bunga menghasilkan pembagi nol.');
            return;
          }
          pay = P * r / denom;
        }
        var bal = P;
        for (var i = 1; i <= n; i++) {
          var interest = Math.round((bal * r) * 100) / 100;
          var principal = Math.round((pay - interest) * 100) / 100;
          bal = Math.round((bal - principal) * 100) / 100;
          if (i === n) {
            // koreksi sisa rounding kecil
            var adj = bal;
            pay = Math.round((pay - adj) * 100) / 100;
            bal = 0;
          }
          scheduleOut.push({ idx: i, pay: pay, interest: interest, principal: principal, balance: Math.max(0, bal) });
          totalInterest += interest;
        }
      } else { // flat
        var interestMonthly = P * (rateY / 100) / 12;
        var principalMonthly = P / n;
        pay = interestMonthly + principalMonthly;
        var bal2 = P;
        for (var j = 1; j <= n; j++) {
          var interestF = Math.round(interestMonthly * 100) / 100;
          var principalF = Math.round(principalMonthly * 100) / 100;
          bal2 = Math.round((bal2 - principalF) * 100) / 100;
          if (j === n) bal2 = 0;
          scheduleOut.push({ idx: j, pay: pay, interest: interestF, principal: principalF, balance: Math.max(0, bal2) });
          totalInterest += interestF;
        }
      }

      schedule = scheduleOut;
      currentPage = 1;

      sumPrincipal.textContent = fmt(P);
      sumPayment.textContent = fmt(scheduleOut[0] ? scheduleOut[0].pay : 0);
      sumInterest.textContent = fmt(totalInterest);
      sumTotal.textContent = fmt(P + totalInterest);

      tableSection.classList.remove('hidden');
      dlBtn.disabled = false; printBtn.disabled = false;
      renderTable();
    }

    function renderTable() {
      var rowsSetting = rowsPerPageEl.value;
      var perPage = rowsSetting === 'Semua' ? schedule.length : parseInt(rowsSetting, 10);
      var totalPages = Math.max(1, Math.ceil(schedule.length / perPage));
      if (currentPage > totalPages) currentPage = totalPages;
      var start = (currentPage - 1) * perPage;
      var end = rowsSetting === 'Semua' ? schedule.length : start + perPage;

      var rows = [];
      for (var k = start; k < end && k < schedule.length; k++) {
        var row = schedule[k];
        var tr = "<tr class='odd:bg-white even:bg-slate-50'>" +
                 "<td class='px-4 py-2'>" + row.idx + "</td>" +
                 "<td class='px-4 py-2 text-right'>" + fmt(row.pay) + "</td>" +
                 "<td class='px-4 py-2 text-right'>" + fmt(row.interest) + "</td>" +
                 "<td class='px-4 py-2 text-right'>" + fmt(row.principal) + "</td>" +
                 "<td class='px-4 py-2 text-right'>" + fmt(row.balance) + "</td>" +
                 "</tr>";
        rows.push(tr);
      }

      tableBody.innerHTML = rows.join('');
      pageInfo.textContent = "Halaman " + currentPage + " dari " + totalPages;
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
    }

    function downloadCSV() {
      if (!schedule.length) return;
      var header = ['Periode', 'Pembayaran', 'Bunga', 'Pokok', 'Sisa Pokok'];
      var lines = [header.join(',')];
      for (var m = 0; m < schedule.length; m++) {
        var r = schedule[m];
        var line = [r.idx, Math.round(r.pay), Math.round(r.interest), Math.round(r.principal), Math.round(r.balance)].join(',');
        lines.push(line);
      }
      var csv = lines.join('\n');
      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url; a.download = 'amortisasi.csv'; a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
